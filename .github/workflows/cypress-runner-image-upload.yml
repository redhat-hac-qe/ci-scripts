name: Cypress runner image upload

on:
  schedule:
    - cron: "*/30 * * * *"
    
jobs:
  changes:
    name: Check for changes from last run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout hac-dev
        uses: actions/checkout@v3
        with:
          repository: openshift/hac-dev
          path: hac-dev
      - name: Check the changes to tests since last run
        id: changes
        run: |
          set +e
          cd hac-dev
          timestamp=$(date +%Y-%m-%dT%T --date '-30 min')
          git log --since="$timestamp" --name-only --pretty=format: | sort -u | grep integration-tests/
          updates=$?
          if [ $updates -ne 0 ]; then
            echo "No changes"
            echo "push_image=true" >> $GITHUB_OUTPUT
          else 
            echo "Changes detected"
            echo "push_image=true" >> $GITHUB_OUTPUT
          fi
      - name: Build and push image
        if: steps.changes.outputs.push_image == 'true'
        run: |
          cd hac-dev/integration-tests
          podman build -f Dockerfile -t quay.io/hacdev/hac-tests:next
